import { PreprocessResult } from '../../types/common.js';
import { openai } from '../../services/openaiService.js';
import { CHAT_MODEL } from '../../config/environment.js';
import type { ChatCompletionMessageParam } from 'openai/resources/chat/completions';
import { smartSplitQuestions } from '../questionSplitting/splitQuestions.js';

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –∫ –±–∏–∑–Ω–µ—Å-—Ç–µ–º–∞—Ç–∏–∫–µ
 * @param text - –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns true –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Å–≤—è–∑–∞–Ω —Å –±–∏–∑–Ω–µ—Å–æ–º
 */
export function isPotentiallyBusinessRelevant(text: string): boolean {
  // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ —è–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ
  if (text.includes('?')) {
    return false;
  }
  
  const businessKeywords = [
    // –¢–∏–ø—ã –±–∏–∑–Ω–µ—Å–∞
    '–∫–æ–º–ø–∞–Ω–∏—è', '–±–∏–∑–Ω–µ—Å', '–º–∞–≥–∞–∑–∏–Ω', '–±–∞–Ω–∫', '—Å–∞–π—Ç', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 
    '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ø–µ—Ä–µ–≤–æ–∑–∫–∏', '—Ç—É—Ä–∏–∑–º', '–∫–ª–∏–µ–Ω—Ç—ã', '–ø—Ä–æ–¥–∞–∂–∏', '–µ-–∫–æ–º–º–µ—Ä—Ü–∏—è',
    '—Ñ–∏—Ä–º–∞', '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', '–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ', '–∏–ø', '—Å–µ—Ä–≤–∏—Å', '—É—Å–ª—É–≥–∏',
    
    // –§—Ä–∞–∑—ã –≤–ª–∞–¥–µ–Ω–∏—è/–ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏
    '—É –º–µ–Ω—è', '–Ω–∞—à', '–º–æ—è', '–º–æ–π', '–Ω–∞—à–∞', '—Ä–∞–±–æ—Ç–∞—é –≤', '—è–≤–ª—è—é—Å—å',
    '—è —Ä–∞–±–æ—Ç–∞—é', '—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é', '—è –≤–ª–∞–¥–µ–ª–µ—Ü', '–º—ã –∑–∞–Ω–∏–º–∞–µ–º—Å—è',
    
    // –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    '–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤', '—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∞ –≤', '–±–∞–∑–∏—Ä—É–µ—Ç—Å—è –≤', '–æ—Ñ–∏—Å –≤',
    
    // –†–∞–∑–º–µ—Ä –±–∏–∑–Ω–µ—Å–∞
    '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', '—Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', '—á–µ–ª–æ–≤–µ–∫ –≤ —à—Ç–∞—Ç–µ', '–º–∞–ª—ã–π –±–∏–∑–Ω–µ—Å',
    '—Å—Ä–µ–¥–Ω–∏–π –±–∏–∑–Ω–µ—Å', '–∫—Ä—É–ø–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è', '—à—Ç–∞—Ç',
    
    // –¶–∏—Ñ—Ä–æ–≤–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
    '–µ—Å—Ç—å —Å–∞–π—Ç', '—Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏', '–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å',
    '—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω', '–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞'
  ];
  
  const lowerText = text.toLowerCase();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  const hasBusinessKeywords = businessKeywords.some(keyword => lowerText.includes(keyword));
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –æ–ø–∏—Å—ã–≤–∞—é—â–∏—Ö –±–∏–∑–Ω–µ—Å
  const startsWithBusinessDescriptor = 
    lowerText.startsWith('—è') || 
    lowerText.startsWith('–º—ã') || 
    lowerText.startsWith('–Ω–∞—à–∞') || 
    lowerText.startsWith('—É –Ω–∞—Å') ||
    lowerText.startsWith('—É –º–µ–Ω—è');
  
  // –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–∞—á–∞–ª–µ –¥–∏–∞–ª–æ–≥–∞ - –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  if (text.length < 50) {
    // –ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –±–∏–∑–Ω–µ—Å-–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    return startsWithBusinessDescriptor && hasBusinessKeywords;
  }
  
  // –î–ª—è –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  return hasBusinessKeywords;
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É
 * @param text - –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
 * @returns –¢–µ–∫—Å—Ç –≤ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ
 */
export function convertDescriptiveToQuestion(text: string): string {
  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫, –≤–µ—Ä–Ω–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
  if (text.includes('?')) return text;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
  const lower = text.toLowerCase();
  
  // –ú–∞—Å—Å–∏–≤ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π –≤ –≤–æ–ø—Ä–æ—Å—ã
  const patterns = [
    // –§–æ—Ä–º–∞—Ç: [–ø–∞—Ç—Ç–µ—Ä–Ω, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ]
    // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
    ['—è —É–∫—Ä–∞–∏–Ω—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–∞–π—Ç–∞ –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏?'],
    ['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–∞–π—Ç–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['–∫–æ–º–ø–∞–Ω–∏—è –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏', '–ö–∞–∫ European Accessibility Act –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏—è–º, –∑–∞–Ω–∏–º–∞—é—â–∏–º—Å—è –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞–º–∏?'],
    ['–ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏', '–ö–∞–∫–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏—Ö –ø–µ—Ä–µ–≤–æ–∑–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    
    // –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –±–∏–∑–Ω–µ—Å–∞
    ['—è –∫–æ–º–ø–∞–Ω–∏—è', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–∞–π—Ç–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['—É –º–µ–Ω—è –±–∏–∑–Ω–µ—Å', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è European Accessibility Act –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –º–æ–µ–º—É –±–∏–∑–Ω–µ—Å—É?'],
    ['–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['–æ–Ω–ª–∞–π–Ω-—Ç–æ—Ä–≥–æ–≤–ª—è', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–Ω–ª–∞–π–Ω-—Ç–æ—Ä–≥–æ–≤–ª–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç European Accessibility Act?'],
    ['–±–∞–Ω–∫', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–º –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç European Accessibility Act?'],
    
    // –£—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã
    ['–ø–µ—Ä–µ–≤–æ–∂—É –ª—é–¥–µ–π', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–∞–π—Ç–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['–ø—Ä–æ–¥–∞—é –±–∏–ª–µ—Ç—ã', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-—Å–∞–π—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –±–∏–ª–µ—Ç–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['–ø—Ä–æ–¥–∞—é –æ–Ω–ª–∞–π–Ω', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–Ω–ª–∞–π–Ω-–ø—Ä–æ–¥–∞–∂–∞–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç European Accessibility Act?'],
    ['–æ–∫–∞–∑—ã–≤–∞—é —É—Å–ª—É–≥–∏', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–∫–∞–∑–∞–Ω–∏–∏ —É—Å–ª—É–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç European Accessibility Act?'],
    
    // Web –∏ –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ['—Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º', '–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    ['–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç European Accessibility Act?'],
    ['–≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?'],
    
    // –û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    ['–Ω—É–∂–Ω–æ', '–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º European Accessibility Act?'],
    ['–Ω–∞–¥–æ', '–ß—Ç–æ –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º European Accessibility Act?'],
    ['—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è', '–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è European Accessibility Act –ø—Ä–∏–º–µ–Ω–∏–º—ã –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ?'],
    ['–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–∏', '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–∏ —Å–æ–±–ª—é–¥–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è European Accessibility Act –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ?'],
    ['—à—Ç—Ä–∞—Ñ—ã', '–ö–∞–∫–∏–µ —à—Ç—Ä–∞—Ñ—ã –≥—Ä–æ–∑—è—Ç –∑–∞ –Ω–µ—Å–æ–±–ª—é–¥–µ–Ω–∏–µ European Accessibility Act?'],
    ['—Å—Ä–æ–∫–∏', '–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π European Accessibility Act?']
  ];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –∑–∞–ø—Ä–æ—Å–µ
  for (const [pattern, question] of patterns) {
    if (lower.includes(pattern)) {
      console.log(`üîÑ [TRANSFORM] –ü—Ä–µ–æ–±—Ä–∞–∑—É—é –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å "${text}" –≤ –≤–æ–ø—Ä–æ—Å: "${question}"`);
      return question;
    }
  }
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω–µ—Ü
  return `${text} –ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–∏–º–µ–Ω–∏–º—ã —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?`;
}

/**
 * –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param input - –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
 */
export async function preprocessQuery(input: string): Promise<PreprocessResult> {
  console.log('\nüß† [PREPROCESS] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏...');
  
  const messages: ChatCompletionMessageParam[] = [
    {
      role: 'system',
      content: `
–¢—ã ‚Äî –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –æ European Accessibility Act (EAA).
–£ —Ç–µ–±—è —Ç—Ä–∏ –∑–∞–¥–∞—á–∏:

1. –û–ü–†–ï–î–ï–õ–ò–¢–¨, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∫ —Ç–µ–º–µ European Accessibility Act (EAA) –∏–ª–∏ –≤–µ–±-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
2. –î–ª—è –ù–ï–Ø–°–ù–´–• –∏–ª–∏ –ö–û–†–û–¢–ö–ò–• –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –£–¢–û–ß–ù–ï–ù–ò–Ø.
3. –£–õ–£–ß–®–ò–¢–¨ –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–º–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: EAA –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —à–∏—Ä–æ–∫–æ–º—É —Å–ø–µ–∫—Ç—Ä—É –±–∏–∑–Ω–µ—Å–æ–≤ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –≤–∫–ª—é—á–∞—è:
- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø–µ—Ä–µ–≤–æ–∑—á–∏–∫–∏
- –ë–∞–Ω–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è
- –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–æ–º–º–µ—Ä—Ü–∏—è –∏ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω—ã
- –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –∏ —Å–µ—Ä–≤–∏—Å—ã
- –ú–µ–¥–∏–∞ –∏ —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
- –ò –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏–ª–∏ —Å–∞–π—Ç–∞–º–∏

–ü–†–ê–í–ò–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ü–†–û–°–û–í:
1. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ö–†–ê–¢–ö–ò–ô (–º–µ–Ω–µ–µ 5 —Å–ª–æ–≤) –∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ –∏–ª–∏ –æ—Ç—Ä–∞—Å–ª—å - —Å—á–∏—Ç–∞–π –µ–≥–æ –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –†–ï–õ–ï–í–ê–ù–¢–ù–´–ú.
   –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—Å—Ç–∞–Ω–æ–≤–∏ needMoreInfo=true –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ 3-5 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

2. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –±–µ–∑ —è–≤–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ - —Å—á–∏—Ç–∞–π –µ–≥–æ –†–ï–õ–ï–í–ê–ù–¢–ù–´–ú –∏ —Ç—Ä–µ–±—É—é—â–∏–º —É—Ç–æ—á–Ω–µ–Ω–∏—è.

3. –ó–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "—É –º–µ–Ω—è [—Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞]" –∏–ª–∏ "—è —Ä–∞–±–æ—Ç–∞—é –≤ [–æ—Ç—Ä–∞—Å–ª–∏]" - –í–°–ï–ì–î–ê —Å—á–∏—Ç–∞–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –∏ —Ç—Ä–µ–±—É—é—â–∏–º–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è.

–°–¢–†–û–ì–û –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "isRelevant": true/false, // –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∫ European Accessibility Act –∏–ª–∏ –≤–µ–±-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  "explanation": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –≤–æ–ø—Ä–æ—Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏–ª–∏ –Ω–µ—Ç",
  "reformulatedQuery": "—É–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞" // —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ isRelevant=true
  "needMoreInfo": true/false, // –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  "clarificationQuestions": ["–≤–æ–ø—Ä–æ—Å1", "–≤–æ–ø—Ä–æ—Å2"] // –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ needMoreInfo=true
}

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –µ—Å—Ç—å –ª—é–±–∞—è —Ñ—Ä–∞–∑–∞ –æ European Accessibility Act, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Ü–∏—Ñ—Ä–æ–≤–æ–º –ø—Ä–æ–¥—É–∫—Ç–µ, —Å—á–∏—Ç–∞–π –∑–∞–ø—Ä–æ—Å –†–ï–õ–ï–í–ê–ù–¢–ù–´–ú.
- –í–æ–ø—Ä–æ—Å—ã –æ –¥—Ä—É–≥–∏—Ö —Ç–µ–º–∞—Ö (–Ω–µ EAA, –Ω–µ –≤–µ–±-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, –Ω–µ –±–∏–∑–Ω–µ—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏) - –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ - –í–°–Å –†–ê–í–ù–û –æ—Ü–µ–Ω–∏ –µ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ —Å–º—ã—Å–ª—É.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ accessibility, web, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, –∏–Ω–≤–∞–ª–∏–¥ –∏ –ø–æ—Ö–æ–∂–∏–µ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ–Ω —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø–∏—Å–∞–Ω —Å –æ—à–∏–±–∫–∞–º–∏ –∏–ª–∏ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ - –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –µ–≥–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.
- –î–ª—è –±–∏–∑–Ω–µ—Å-–∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "—É –º–µ–Ω—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è" –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–∑–º–µ—Ä–µ –∫–æ–º–ø–∞–Ω–∏–∏, –Ω–∞–ª–∏—á–∏–∏ —Å–∞–π—Ç–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ä–∞–±–æ—Ç–µ –≤ –ï–° –∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ EAA.
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í—Å–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –ø–æ–ª–µ clarificationQuestions –¥–æ–ª–∂–Ω—ã –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –∑–Ω–∞–∫–æ–º –≤–æ–ø—Ä–æ—Å–∞.
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ clarificationQuestions –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –¥–µ—Ñ–∏—Å–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–µ -", "–ù–∞—à –±–∏–∑–Ω–µ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–µ–∫—Ç–æ—Ä–µ -"

üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –í–û–ü–†–û–°–´:
- –í–æ–ø—Ä–æ—Å—ã –æ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–∏ EAA —Ç–µ—Ä–º–∏–Ω–æ–≤ –í–°–ï–ì–î–ê –†–ï–õ–ï–í–ê–ù–¢–ù–´: "—á—Ç–æ –∑–∞ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤", "—á—Ç–æ —Ç–∞–∫–æ–µ WCAG", "–Ω–µ –ø–æ–Ω—è–ª –∞—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"
- –í—ã—Ä–∞–∂–µ–Ω–∏—è —Ñ—Ä—É—Å—Ç—Ä–∞—Ü–∏–∏ —Å —Ç–µ—Ä–º–∏–Ω–∞–º–∏ EAA ("–Ω–µ –ø–æ–Ω—è–ª", "—á—Ç–æ –∑–∞", "–æ–±—ä—è—Å–Ω–∏—Ç–µ") - –í–°–ï–ì–î–ê –†–ï–õ–ï–í–ê–ù–¢–ù–´
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –æ —Ç–µ—Ä–º–∏–Ω–∞—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —á–∞—Ç-–±–æ—Ç–∞ - —ç—Ç–æ –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –¥–∏–∞–ª–æ–≥–∞ –æ EAA
- –î–∞–∂–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞, –Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ EAA —Ç–µ—Ä–º–∏–Ω–∞—Ö - –†–ï–õ–ï–í–ê–ù–¢–ù–û

–ü–†–ò–ú–ï–†–´:
1. "—É –º–µ–Ω—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è" -> isRelevant=true, needMoreInfo=true, clarificationQuestions=["–ù–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –≤–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è –≤ –ï–°?", "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –≤–µ–±-—Å–∞–π—Ç –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?", "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–µ -"]
2. "—è –ø—Ä–æ–¥–∞–≤–µ—Ü" -> isRelevant=true, needMoreInfo=true, clarificationQuestions=["–ü—Ä–æ–¥–∞–µ—Ç–µ –ª–∏ –≤—ã —Ç–æ–≤–∞—Ä—ã –æ–Ω–ª–∞–π–Ω?", "–ö–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞?", "–ú–æ–π –±–∏–∑–Ω–µ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–µ–∫—Ç–æ—Ä–µ -"]
3. "–ø—Ä–∏–≤–µ—Ç –∫–∞–∫ –¥–µ–ª–∞" -> isRelevant=false
4. "—á—Ç–æ –∑–∞ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤" -> isRelevant=true, reformulatedQuery="–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ EAA?"
5. "–Ω–µ –ø–æ–Ω—è–ª, –±–ª—è–¥—å, –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤" -> isRelevant=true, reformulatedQuery="–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∞—É–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–æ–≥–ª–∞—Å–Ω–æ European Accessibility Act?"
6. "—á—Ç–æ —Ç–∞–∫–æ–µ WCAG" -> isRelevant=true, reformulatedQuery="–ß—Ç–æ —Ç–∞–∫–æ–µ WCAG –∏ –∫–∞–∫ –æ–Ω —Å–≤—è–∑–∞–Ω —Å European Accessibility Act?"
`
    },
    { role: 'user', content: input }
  ];
  
  try {
    const completion = await openai.chat.completions.create({
      model: CHAT_MODEL,
      messages,
      temperature: 0,
      response_format: { type: 'json_object' }
    });
    
    const rawResponse = completion.choices[0].message.content || '{}';
    console.log('üß† [PREPROCESS] –û—Ç–≤–µ—Ç –æ—Ç –ò–ò-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:', rawResponse);
    
    try {
      const result = JSON.parse(rawResponse);
      console.log(`‚úÖ [PREPROCESS] –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${result.isRelevant ? '–†–ï–õ–ï–í–ê–ù–¢–ï–ù' : '–ù–ï –†–ï–õ–ï–í–ê–ù–¢–ï–ù'}`);
      if (result.isRelevant && result.reformulatedQuery) {
        console.log(`‚úÖ [PREPROCESS] –£–ª—É—á—à–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: "${result.reformulatedQuery}"`);
      }
      if (result.needMoreInfo) {
        console.log(`‚úÖ [PREPROCESS] –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ. –í–æ–ø—Ä–æ—Å—ã: ${result.clarificationQuestions?.join(', ')}`);
      }
      
      // –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –æ–Ω —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
      let splitQuestions: string[] = [input];
      if (result.isRelevant) {
        const splitTimer = performance.now();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π
        const queryToSplit = result.reformulatedQuery || input;
        splitQuestions = await smartSplitQuestions(queryToSplit);
        console.log(`‚è± [SPLIT] Time: ${Math.round(performance.now() - splitTimer)}ms`);
        console.log(`üîÄ [SPLIT] –ü–æ–ª—É—á–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${splitQuestions.length}`);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–∏–ø–æ–º
      const enhancedResult: PreprocessResult = {
        ...result,
        needsClarification: result.needMoreInfo || false,
        suggestions: result.clarificationQuestions || [],
        splitQuestions
      };
      
      return enhancedResult;
    } catch (e) {
      console.error('‚ùå [PREPROCESS] Error parsing JSON from model response:', e);
      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, —Å—á–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      return { 
        isRelevant: true, 
        needsClarification: false, 
        suggestions: [],
        splitQuestions: [input]
      };
    }
    
  } catch (e) {
    console.error('‚ùå [PREPROCESS] Error calling OpenAI:', e);
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ API —Å—á–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return { 
      isRelevant: true, 
      needsClarification: false, 
      suggestions: [],
      splitQuestions: [input]
    };
  }
}