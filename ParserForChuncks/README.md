# RAG Server для European Accessibility Act (TypeScript)

## Описание проекта

RAG Server — это сервер на TypeScript, реализующий функциональность Retrieval-Augmented Generation (RAG) для работы с вопросами и ответами по документации European Accessibility Act (EAA). Проект построен с использованием Node.js, Express, OpenAI API и Supabase для эффективного поиска и генерации релевантных ответов на основе контекста.

**Версия проекта**: 1.0.0

## Быстрый старт

1. Скопируйте `.env.example` в `.env` и заполните переменные:
   - `OPENAI_API_KEY` — ключ API OpenAI
   - `SUPABASE_URL` — URL вашей базы Supabase
   - `SUPABASE_SERVICE_KEY` — сервисный ключ Supabase
   - `PORT` — порт для запуска сервера (опционально, по умолчанию 3000)

2. Установите зависимости:
```powershell
pnpm install
```

3. Соберите проект:
```powershell
pnpm run build
```

4. Запустите сервер:
```powershell
pnpm start
```

Или используйте комбинированную команду для сборки и запуска:
```powershell
pnpm run build-and-run
```

## Основные компоненты системы

### Серверная часть
- **RAG-процессор** — извлекает релевантные чанки текста из базы знаний
- **Интеллектуальный анализатор вопросов** — разбивает сложные запросы на простые подвопросы
- **Векторный поиск** — находит наиболее релевантные чанки с помощью косинусного сходства
- **Система памяти** — хранит историю диалогов для персонализации ответов
- **Генератор контекста** — формирует оптимальный контекст для LLM на основе найденных чанков

### Клиентская часть
- **Реактивный интерфейс** — построен на React с использованием Tailwind CSS
- **Потоковый вывод** — отображает ответы в реальном времени
- **Управление сессиями** — позволяет пользователю работать с разными диалогами
- **Визуализация метаданных** — показывает релевантность и источники информации

## API-эндпоинты

### Основные
- `POST /ask` — получить ответ на вопрос по датасету
- `GET /health` — проверка статуса сервера
- `GET /config` — получение конфигурации API

### Управление историей чата
- `GET /chat/sessions/:userId` — получение списка сессий пользователя
- `GET /chat/messages/:sessionId` — получение сообщений конкретной сессии
- `DELETE /chat/sessions/:sessionId` — удаление сессии

### Пример запроса к API

```json
{
  "question": "Какие обязательства у производителей по EAA?",
  "user_id": "user123",
  "session_id": "session456",
  "dataset_id": "eaa",
  "similarity_threshold": 0.78,
  "max_chunks": 5,
  "stream": true
}
```

## Структура документации

В проекте используется подробная документация по European Accessibility Act, разбитая на главы:
- `Chapter_0.md` — Предисловие и введение
- `Chapter_1.md` — Введение, определения и цели EAA
- `Chapter_2.md` — Область применения и требования
- `Chapter_3.md` — Исключения
- `Chapter_4.md` — Обязательства
- `Chapter_5.md` — Соответствие и соблюдение
- `Chapter_6.md` — Мониторинг
- `ALL_Chapters_0-6.md` — Объединенный файл всех глав для удобства

## Инструменты для работы с данными

### Загрузка Markdown в Supabase

Для загрузки markdown-файла в Supabase используйте:
```powershell
node markdown_to_supabase.js
```

Система автоматически разбивает документы на оптимальные чанки (до 300 токенов), создает векторные представления с использованием OpenAI и загружает их в базу данных Supabase.

Для извлечения загруженных чанков:
```powershell
node extract_chunks_from_supabase.js
```

## Технический стек

### Backend
- **Node.js** — платформа выполнения
- **TypeScript** — язык программирования
- **Express** — веб-фреймворк
- **OpenAI API** — для генерации эмбеддингов и ответов (модель `gpt-4o-mini`)
- **Supabase** — для хранения и векторного поиска чанков (pgvector)
- **Zod** — для валидации данных
- **TikToken** — для точного подсчета токенов
- **UUID** — для генерации уникальных идентификаторов

### Frontend
- **React** — библиотека для создания UI
- **Vite** — инструмент сборки
- **Tailwind CSS** — фреймворк для стилизации

## Примечания
- Для работы с Supabase требуется функция `match_documents`
- Все настройки производятся через файл `.env`
- Пороговое значение сходства по умолчанию: 0.78
- Максимальное количество чанков в контексте: 5
- Система поддерживает потоковый вывод ответов (streaming)
- Файл `failed_chunks.json` используется для логирования ошибок при загрузке чанков
- При запуске проверяется доступность основного порта и, если он занят, автоматически используются резервные порты

## Дополнительная документация
- **README_MEMORY.md** — подробная документация по системе памяти чат-бота
- **AUDIT.md** — результаты аудита кода с описанием архитектуры

## Скрипты проекта
- `build` — компиляция TypeScript в JavaScript
- `start` — запуск сервера из скомпилированного кода
- `dev` — запуск сервера в режиме разработки с ts-node
- `build-and-run` — сборка и запуск в одной команде

---

Если возникнут вопросы — пишите! 